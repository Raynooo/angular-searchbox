"use strict";angular.module("angularjssearchbox",["angularjssearchbox.typeahead"]).directive("sbFocus",["$timeout",function(e){return function(t,n){e(function(){t.useKeywordFacet||n[0].value||n[0].focus()})}}]).directive("repeatDone",function(){return function(e,t){e.bindValueInput(t)}}).directive("searchBox",["$timeout",function(e){return{restrict:"A",templateUrl:"templates/searchBox.html",scope:{resultList:"=",facetList:"=",debug:"=?"},controller:function(t){function n(e){for(var t in e)for(var n in e[t].items)e[t].items[n].hasOwnProperty("label")||(e[t].items[n].label=e[t].items[n].name);return e}function s(e,n){for(var s in t.facetList)if(t.facetList[s].name===e)for(var i in t.facetList[s].items)if(t.facetList[s].items[i].name===n)return t.facetList[s].items[i].label;return n}function i(e){var t=[];for(var n in e){var i=new Object;i.key=e[n].key,i.type="string",i.value=s(i.key,e[n].value),t.push(i)}return t}t.facetList=n(t.facetList),t.sbResultList=i(t.resultList),e(function(){t.selected={key:"",value:""}})},link:function(t,n){t.tmpInputValue=null,t.selectedResult=null,t.debug=t.debug||!1,t.useKeywordFacet=!1,t.hasKeywordFacet=!1;var s=[9,13,37,39];n.find("input").bind("keydown",function(n){-1!==s.indexOf(n.which)&&(n.preventDefault(),13===n.which?(t.useKeywordFacet=!0,e(function(){t.useKeywordFacet&&(t.selected.value="",t.hasKeywordFacet?(t.sbResultList[t.sbResultList.length-1].value+=" "+t.selected.key,t.resultList[t.resultList.length-1].value+=" "+t.selected.key):(t.hasKeywordFacet=!0,t.sbResultList.push({key:"text",type:"string",value:t.selected.key}),t.resultList.push({key:"text",type:"string",value:t.selected.key})),t.selected.key="",e(function(){t.selectInputFacet(),t.selectedResult=null}))})):9===n.which&&t.$apply(function(){}))}),t.bindValueInput=function(n){e(function(){n.find("input").bind("keydown",function(e){-1!==s.indexOf(e.which)&&(e.preventDefault(),(13===e.which||9===e.which)&&(console.log(e),t.hasKeywordFacet&&t.$apply(function(){if("text"!=t.sbResultList[t.sbResultList.length-1].key){var e=t.sbResultList.pop();t.sbResultList.splice(t.sbResultList.length-1,0,e)}}),t.$apply(function(){var n=new Object;n.key=t.sbResultList[e.srcElement.dataset.tahIndex].key,n.type=t.sbResultList[e.srcElement.dataset.tahIndex].type,n.value=t.sbResultList[e.srcElement.dataset.tahIndex].value,t.resultList[e.srcElement.dataset.tahIndex]=n,t.selectInputFacet(),t.selectedResult=null})))})})},t.selectInputFacet=function(){n.find("input")[n.find("input").length-1].focus()},t.getFacetLabel=function(e){for(var n in t.facetList)if(t.facetList[n].name==e)return t.facetList[n].label;return e},t.getValueName=function(e,n,s){for(var i in t.facetList)if(t.facetList[i].name==e)return t.facetList[i].items[n].name;return s},t.getValues=function(e){for(var n in t.facetList)if(t.facetList[n].name==e)return t.facetList[n].items;return[]},t.$on("$typeahead.select",function(n,s,i,a){t.$apply(function(){t.useKeywordFacet=!1,-1==a?(t.selected.value="",t.sbResultList.push({key:s.name,type:s.type,value:""}),t.selected.key=""):e(function(){if(t.hasKeywordFacet&&"text"!=t.sbResultList[t.sbResultList.length-1].key){var e=t.sbResultList.pop();t.sbResultList.splice(t.sbResultList.length-1,0,e),a+=-1}var n=new Object;n.key=t.sbResultList[a].key,n.type=t.sbResultList[a].type,n.value=t.getValueName(n.key,i,s),t.resultList[a]=n,t.selectInputFacet(),t.selectedResult=null},100)})}),t.selectResult=function(e){t.selectedResult=e},t.removeFilter=function(e){"text"===t.sbResultList[e].key&&(t.hasKeywordFacet=!1),t.sbResultList.splice(e,1),t.resultList=t.sbResultList.slice(0)},t.removeAll=function(){t.hasKeywordFacet=!1,t.sbResultList.length=0,t.resultList.length=0}}}}]),angular.module("angularjssearchbox.typeahead",["mgcrea.ngStrap.tooltip","mgcrea.ngStrap.helpers.parseOptions"]).provider("$typeahead",function(){var e=this.defaults={animation:"am-fade",prefixClass:"typeahead",placement:"bottom-left",template:"templates/typeAhead.html",trigger:"focus",container:!1,keyboard:!0,html:!1,delay:0,minLength:1,tahIndex:-1,filter:"filter",limit:6};this.$get=function(t,n,s){function i(t,n,i){var a={},l=angular.extend({},e,i);a=s(t,l);var u=i.scope,c=a.$scope;c.$resetMatches=function(){c.$matches=[],c.$activeIndex=0},c.$resetMatches(),c.$activate=function(e){c.$$postDigest(function(){a.activate(e)})},c.$select=function(e){c.$$postDigest(function(){a.select(e)})},c.$isVisible=function(){return a.$isVisible()},a.update=function(e){c.$matches=e,c.$activeIndex>=e.length&&(c.$activeIndex=0)},a.activate=function(e){c.$activeIndex=e},a.select=function(e){var t=c.$matches[e].value;n.$setViewValue(t),c.$resetMatches(),n.$render(),u&&u.$digest(),c.$emit("$typeahead.select",t,e,l.tahIndex)},a.$isVisible=function(){return l.minLength&&n?c.$matches.length&&angular.isString(n.$viewValue)&&n.$viewValue.length>=l.minLength:!!c.$matches.length},a.$getIndex=function(e){var t=c.$matches.length,n=t;if(t){for(n=t;n--&&c.$matches[n].value!==e;);if(!(0>n))return n}},a.$onMouseDown=function(e){e.preventDefault(),e.stopPropagation()},a.$onKeyDown=function(e){/(38|40|13)/.test(e.keyCode)&&(e.preventDefault(),e.stopPropagation(),13===e.keyCode&&c.$matches.length?a.select(c.$activeIndex):38===e.keyCode&&c.$activeIndex>0?c.$activeIndex--:40===e.keyCode&&c.$activeIndex<c.$matches.length-1?c.$activeIndex++:angular.isUndefined(c.$activeIndex)&&(c.$activeIndex=0),c.$digest())};var r=a.show;a.show=function(){r(),setTimeout(function(){a.$element.on("mousedown",a.$onMouseDown),l.keyboard&&t.on("keydown",a.$onKeyDown)})};var o=a.hide;return a.hide=function(){a.$element.off("mousedown",a.$onMouseDown),l.keyboard&&t.off("keydown",a.$onKeyDown),o()},a}angular.element(t.document.body);return i.defaults=e,i}}).directive("sbTypeahead",function(e,t,n,s,i){var a=s.defaults;return{restrict:"EAC",require:"ngModel",link:function(e,t,n,l){var u={scope:e};angular.forEach(["placement","container","delay","trigger","keyboard","html","animation","template","filter","limit","tahIndex","minLength"],function(e){angular.isDefined(n[e])&&(u[e]=n[e])});var c=u.filter||a.filter,r=u.limit||a.limit,o=n.ngOptions;c&&(o+=" | "+c+":$viewValue"),r&&(o+=" | limitTo:"+r);var f=i(o),d=s(t,l,u);e.$watch(n.ngModel,function(t){e.$modelValue=t,f.valuesFn(e,l).then(function(e){e.length>r&&(e=e.slice(0,r)),(1!==e.length||e[0].value!==t)&&(d.update(e),l.$render())})}),l.$render=function(){if(l.$isEmpty(l.$viewValue))return t.val("");var e=d.$getIndex(l.$modelValue),n=angular.isDefined(e)?d.$scope.$matches[e].label:l.$viewValue;n=angular.isObject(n)?n.label:n,t.val(n.replace(/<(?:.|\n)*?>/gm,"").trim())},e.$on("$destroy",function(){d.destroy(),u=null,d=null})}}});