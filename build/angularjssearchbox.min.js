"use strict";angular.module("angularjssearchbox",["angularjssearchbox.typeahead"]).directive("sbFocus",["$timeout",function(e){return function(t,n){e(function(){t.useKeywordFacet||n[0].value||n[0].focus()})}}]).directive("repeatDone",function(){return function(e,t){e.bindValueInput(t)}}).directive("searchBox",["$timeout",function(e){return{restrict:"A",templateUrl:"templates/searchBox.html",scope:{resultList:"=",facetList:"=",debug:"=?",placeholder:"@?"},link:function(t,n){function i(e){for(var n in t.facetList)if(t.facetList[n].name===e)return t.facetList[n];return null}function o(e){for(var t in e)for(var n in e[t].items)e[t].items[n].hasOwnProperty("label")||(e[t].items[n].label=e[t].items[n].name);return e}function a(e,n){for(var i in t.facetList)if(t.facetList[i].name===e)for(var o in t.facetList[i].items)if(t.facetList[i].items[o].name===n)return t.facetList[i].items[o].label;return n}function s(e){for(var n in t.facetList)if(t.facetList[n].name===e)return t.facetList[n].type;return"string"}function l(e){var t=[];for(var n in e){var i=new Object;i.key=e[n].key,i.type=s(i.key),i.value=a(i.key,e[n].value),t.push(i)}return t}t.tmpInputValue=null,t.selectedResult=null,t.debug=t.debug||!1,t.placeholder=t.placeholder||"Filtrer les données",t.useKeywordFacet=!1,t.hasKeywordFacet=!1,t.initDone=!1,t.values={},t.showPlaceHolder=!0,t.$watch("facetList",function(e){t.sbFacetList=o(e),t.initDone=!1,t.sbResultList=l(t.resultList),t.hasOwnProperty("selected")||(t.selected={key:"",value:""})}),t.$watch("resultList",function(e){t.initDone=!1,t.sbResultList=l(e)});var u=[9,13,37,38,39,40];n.find("input").bind("keydown",function(n){-1!==u.indexOf(n.which)&&(n.preventDefault(),13===n.which?(t.useKeywordFacet=!0,e(function(){t.useKeywordFacet&&(t.selected.value="",t.initDone=!0,t.hasKeywordFacet?(t.sbResultList[t.sbResultList.length-1].value+=" "+t.selected.key,t.resultList[t.resultList.length-1].value+=" "+t.selected.key):(t.hasKeywordFacet=!0,t.sbResultList.push({key:"text",type:"string",value:t.selected.key}),t.resultList.push({key:"text",type:"string",value:t.selected.key})),t.selected.key="",e(function(){t.selectInputFacet(),t.selectedResult=null}))})):9===n.which&&t.$apply(function(){}))}),n.find("input").bind("focus",function(){t.$apply(function(){t.showPlaceHolder=!1})}).bind("blur",function(){t.$apply(function(){t.showPlaceHolder=!0})}),t.bindValueInput=function(n){e(function(){n.find("input").bind("keydown",function(n){return-1===u.indexOf(n.which)?void(t.initDone=!0):(n.preventDefault(),void((13===n.which||9===n.which)&&(t.hasKeywordFacet&&t.$apply(function(){if("text"!=t.sbResultList[t.sbResultList.length-1].key){var e=t.sbResultList.pop();t.sbResultList.splice(t.sbResultList.length-1,0,e)}}),t.$apply(function(){var i=new Object;i.key=t.sbResultList[n.target.dataset.tahIndex].key,i.type=t.sbResultList[n.target.dataset.tahIndex].type,i.value=t.sbResultList[n.target.dataset.tahIndex].value,t.resultList[n.target.dataset.tahIndex]=i,e(function(){t.selectInputFacet()}),t.selectedResult=null}))))})},50)},t.selectInputFacet=function(){n.find("input")[n.find("input").length-1].focus()},t.getFacetLabel=function(e){for(var n in t.sbFacetList)if(t.sbFacetList[n].name==e)return t.sbFacetList[n].label;return"text"===e?"Mot(s) clé(s)":e},t.getValueName=function(e,n,i){return t.values[e][n].name||i},t.getValues=function(e,n){var o=i(e);return o?"function"==typeof o.items?t.initDone?(t.initDone=!1,o.items(n,e).then(function(n){return t.values[e]=n,n})):[]:(t.values[e]=o.items,o.items):void 0},t.$on("$typeahead.select",function(n,i,o,a){t.$apply(function(){t.useKeywordFacet=!1,-1==a?(t.selected.value="",t.sbResultList.push({key:i.name,type:i.type,value:""}),t.selected.key="",t.initDone=!0):e(function(){if(t.hasKeywordFacet&&"text"!=t.sbResultList[t.sbResultList.length-1].key){var e=t.sbResultList.pop();t.sbResultList.splice(t.sbResultList.length-1,0,e),a+=-1}var n=new Object;n.key=t.sbResultList[a].key,n.type=t.sbResultList[a].type,n.value=t.getValueName(n.key,o,i),t.resultList[a]=n,t.selectInputFacet(),t.selectedResult=null},100)})}),t.selectResult=function(e,n){t.selectedResult=e,angular.element(n.currentTarget).find("input")[0].focus()},t.removeFilter=function(e){"text"===t.sbResultList[e].key&&(t.hasKeywordFacet=!1),t.sbResultList.splice(e,1),t.resultList=t.sbResultList.slice(0)},t.removeAll=function(){t.hasKeywordFacet=!1,t.sbResultList.length=0,t.resultList.length=0}}}}]),angular.module("angularjssearchbox.tooltip",["mgcrea.ngStrap.helpers.dimensions"]).provider("$sbtooltip",function(){var e=this.defaults={animation:"am-fade",prefixClass:"tooltip",prefixEvent:"tooltip",container:!1,placement:"top",template:"templates/tooltip.html",contentTemplate:!1,trigger:"hover focus",keyboard:!1,html:!1,show:!1,title:"",type:"",delay:0};this.$get=["$window","$rootScope","$compile","$q","$templateCache","$http","$animate","$timeout","dimensions","$$rAF",function(t,n,i,o,a,s,l,u,r,c){function f(t,o){function a(){return"body"===g.container?r.offset(t[0]):r.position(t[0])}function s(e,t,n,i){var o,a=e.split("-");switch(a[0]){case"right":o={top:t.top+t.height/2-i/2,left:t.left+t.width};break;case"bottom":o={top:t.top+t.height,left:t.left+t.width/2-n/2};break;case"left":o={top:t.top+t.height/2-i/2,left:t.left-n};break;default:o={top:t.top-i,left:t.left+t.width/2-n/2}}if(!a[1])return o;if("top"===a[0]||"bottom"===a[0])switch(a[1]){case"left":o.left=t.left;break;case"right":o.left=t.left+t.width-n}else if("left"===a[0]||"right"===a[0])switch(a[1]){case"top":o.top=t.top-i;break;case"bottom":o.top=t.top+t.height}return o}var u={},f=t[0].nodeName.toLowerCase(),g=u.$options=angular.extend({},e,o);u.$promise=p(g.template);var v=u.$scope=g.scope&&g.scope.$new()||n.$new();g.delay&&angular.isString(g.delay)&&(g.delay=parseFloat(g.delay)),g.title&&(u.$scope.title=g.title),v.$hide=function(){v.$$postDigest(function(){u.hide()})},v.$show=function(){v.$$postDigest(function(){u.show()})},v.$toggle=function(){v.$$postDigest(function(){u.toggle()})},u.$isShown=v.$isShown=!1;var y,b;g.contentTemplate&&(u.$promise=u.$promise.then(function(e){var t=angular.element(e);return p(g.contentTemplate).then(function(e){var n=d('[ng-bind="content"]',t[0]);return n.length||(n=d('[ng-bind="title"]',t[0])),n.removeAttr("ng-bind").html(e),t[0].outerHTML})}));var w,L,k,x;return u.$promise.then(function(e){angular.isObject(e)&&(e=e.data),g.html&&(e=e.replace(m,'ng-bind-html="')),e=h.apply(e),k=e,w=i(e),u.init()}),u.init=function(){g.delay&&angular.isNumber(g.delay)&&(g.delay={show:g.delay,hide:g.delay}),"self"===g.container?x=t:g.container&&(x=d(g.container));var e=g.trigger.split(" ");angular.forEach(e,function(e){"click"===e?t.on("click",u.toggle):"manual"!==e&&(t.on("hover"===e?"mouseenter":"focus",u.enter),t.on("hover"===e?"mouseleave":"blur",u.leave),"button"===f&&"hover"!==e&&t.on($?"touchstart":"mousedown",u.$onFocusElementMouseDown))}),g.show&&v.$$postDigest(function(){"focus"===g.trigger?t[0].focus():u.show()})},u.destroy=function(){for(var e=g.trigger.split(" "),n=e.length;n--;){var i=e[n];"click"===i?t.off("click",u.toggle):"manual"!==i&&(t.off("hover"===i?"mouseenter":"focus",u.enter),t.off("hover"===i?"mouseleave":"blur",u.leave),"button"===f&&"hover"!==i&&t.off($?"touchstart":"mousedown",u.$onFocusElementMouseDown))}L&&(L.remove(),L=null),v.$destroy()},u.enter=function(){return clearTimeout(y),b="in",g.delay&&g.delay.show?void(y=setTimeout(function(){"in"===b&&u.show()},g.delay.show)):u.show()},u.show=function(){v.$emit(g.prefixEvent+".show.before",u);var e=g.container?x:null,n=g.container?null:t;L&&L.remove(),L=u.$element=w(v,function(){}),L.css({top:"0px",left:"0px",display:"block"}).addClass(g.placement),g.animation&&L.addClass(g.animation),g.type&&L.addClass(g.prefixClass+"-"+g.type),l.enter(L,e,n,function(){v.$emit(g.prefixEvent+".show",u)}),u.$isShown=v.$isShown=!0,v.$$phase||v.$root.$$phase||v.$digest(),c(u.$applyPlacement),g.keyboard&&("focus"!==g.trigger?(u.focus(),L.on("keyup",u.$onKeyUp)):t.on("keyup",u.$onFocusKeyUp))},u.leave=function(){return clearTimeout(y),b="out",g.delay&&g.delay.hide?void(y=setTimeout(function(){"out"===b&&u.hide()},g.delay.hide)):u.hide()},u.hide=function(e){return u.$isShown?(v.$emit(g.prefixEvent+".hide.before",u),l.leave(L,function(){v.$emit(g.prefixEvent+".hide",u)}),u.$isShown=v.$isShown=!1,v.$$phase||v.$root.$$phase||v.$digest(),g.keyboard&&null!==L&&L.off("keyup",u.$onKeyUp),e&&"focus"===g.trigger?t[0].blur():void 0):void 0},u.toggle=function(){u.$isShown?u.leave():u.enter()},u.focus=function(){L[0].focus()},u.$applyPlacement=function(){if(L){var e=a(),t=L.prop("offsetWidth"),n=L.prop("offsetHeight"),i=s(g.placement,e,t,n);i.top+="px",i.left+="px",L.css(i)}},u.$onKeyUp=function(e){27===e.which&&u.hide()},u.$onFocusKeyUp=function(e){27===e.which&&t[0].blur()},u.$onFocusElementMouseDown=function(e){e.preventDefault(),e.stopPropagation(),u.$isShown?t[0].blur():t[0].focus()},u}function d(e,t){return angular.element((t||document).querySelectorAll(e))}function p(e){return o.when(a.get(e)||s.get(e)).then(function(t){return angular.isObject(t)?(a.put(e,t.data),t.data):t})}var h=String.prototype.trim,$="createTouch"in t.document,m=/ng-bind="/gi;return f}]}).directive("bsTooltip",["$window","$location","$sce","$sbtooltip","$$rAF",function(e,t,n,i,o){return{restrict:"EAC",scope:!0,link:function(e,t,a){var s={scope:e};angular.forEach(["template","contentTemplate","placement","container","delay","trigger","keyboard","html","animation","type"],function(e){angular.isDefined(a[e])&&(s[e]=a[e])}),angular.forEach(["title"],function(t){a[t]&&a.$observe(t,function(i,a){e[t]=n.trustAsHtml(i),angular.isDefined(a)&&o(function(){l&&l.$applyPlacement()})})}),a.bsTooltip&&e.$watch(a.bsTooltip,function(t,n){angular.isObject(t)?angular.extend(e,t):e.title=t,angular.isDefined(n)&&o(function(){l&&l.$applyPlacement()})},!0);var l=i(t,s);e.$on("$destroy",function(){l.destroy(),s=null,l=null})}}}]),angular.module("angularjssearchbox.typeahead",["angularjssearchbox.tooltip","mgcrea.ngStrap.helpers.parseOptions"]).provider("$typeahead",function(){var e=this.defaults={animation:"am-fade",prefixClass:"typeahead",placement:"bottom-left",template:"templates/typeAhead.html",trigger:"focus",container:!1,keyboard:!0,html:!1,delay:0,minLength:1,tahIndex:-1,filter:"filter",limit:6};this.$get=function(t,n,i){function o(t,n,o){var a={},s=angular.extend({},e,o);a=i(t,s);var l=o.scope,u=a.$scope;u.$resetMatches=function(){u.$matches=[],u.$activeIndex=0},u.$resetMatches(),u.$activate=function(e){u.$$postDigest(function(){a.activate(e)})},u.$select=function(e){u.$$postDigest(function(){a.select(e)})},u.$isVisible=function(){return a.$isVisible()},a.update=function(e){u.$matches=e,u.$activeIndex>=e.length&&(u.$activeIndex=0)},a.activate=function(e){u.$activeIndex=e},a.select=function(e){var t=u.$matches[e].value;n.$setViewValue(t),u.$resetMatches(),n.$render(),l&&l.$digest(),u.$emit("$typeahead.select",t,e,s.tahIndex)},a.$isVisible=function(){return s.minLength&&n?u.$matches.length&&angular.isString(n.$viewValue)&&n.$viewValue.length>=s.minLength:!!u.$matches.length},a.$getIndex=function(e){var t=u.$matches.length,n=t;if(t){for(n=t;n--&&u.$matches[n].value!==e;);if(!(0>n))return n}},a.$onMouseDown=function(e){e.preventDefault(),e.stopPropagation()},a.$onKeyDown=function(e){/(38|40|13)/.test(e.keyCode)&&(e.preventDefault(),e.stopPropagation(),13===e.keyCode&&u.$matches.length?a.select(u.$activeIndex):38===e.keyCode&&u.$activeIndex>0?u.$activeIndex--:40===e.keyCode&&u.$activeIndex<u.$matches.length-1?u.$activeIndex++:angular.isUndefined(u.$activeIndex)&&(u.$activeIndex=0),u.$digest())};var r=a.show;a.show=function(){r(),setTimeout(function(){a.$element.on("mousedown",a.$onMouseDown),s.keyboard&&t.on("keydown",a.$onKeyDown)})};var c=a.hide;return a.hide=function(){a.$element.off("mousedown",a.$onMouseDown),s.keyboard&&t.off("keydown",a.$onKeyDown),c()},a}angular.element(t.document.body);return o.defaults=e,o}}).directive("sbTypeahead",function(e,t,n,i,o){var a=i.defaults;return{restrict:"EAC",require:"ngModel",link:function(e,t,n,s){var l={scope:e};angular.forEach(["placement","container","delay","trigger","keyboard","html","animation","template","filter","limit","tahIndex","minLength"],function(e){angular.isDefined(n[e])&&(l[e]=n[e])});var u=l.filter||a.filter,r=l.limit||a.limit,c=n.ngOptions;u&&(c+=" | "+u+":$viewValue"),r&&(c+=" | limitTo:"+r);var f=o(c),d=i(t,s,l),p=function(){f=o(c),f.valuesFn(e,s).then(function(t){t.length>r&&(t=t.slice(0,r)),(1!==t.length||t[0].value!==e.$modelValue)&&(d.update(t),s.$render())})};n.ngOptionsWatch&&e.$watch(n.ngOptionsWatch,p),e.$watch(n.ngModel,function(t){e.$modelValue=t,p()}),s.$render=function(){if(s.$isEmpty(s.$viewValue))return t.val("");var e=d.$getIndex(s.$modelValue),n=angular.isDefined(e)?d.$scope.$matches[e].label:s.$viewValue;n=angular.isObject(n)?n.label:n,t.val(n.replace(/<(?:.|\n)*?>/gm,"").trim())},e.$on("$destroy",function(){d.destroy(),l=null,d=null})}}});