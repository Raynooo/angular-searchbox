"use strict";angular.module("angularjssearchbox",["angularjssearchbox.typeahead"]).directive("sbFocus",["$timeout",function(e){return function(t,n){e(function(){t.useKeywordFacet||n[0].value||n[0].focus()})}}]).directive("repeatDone",function(){return function(e,t){e.bindValueInput(t)}}).directive("searchBox",["$timeout",function(e){return{restrict:"A",templateUrl:"templates/searchBox.html",scope:{resultList:"=",facetList:"=",debug:"=?"},link:function(t,n){function s(e){for(var t in e)for(var n in e[t].items)e[t].items[n].hasOwnProperty("label")||(e[t].items[n].label=e[t].items[n].name);return e}function a(e,n){for(var s in t.facetList)if(t.facetList[s].name===e)for(var a in t.facetList[s].items)if(t.facetList[s].items[a].name===n)return t.facetList[s].items[a].label;return n}function i(e){var t=[];for(var n in e){var s=new Object;s.key=e[n].key,s.type="string",s.value=a(s.key,e[n].value),t.push(s)}return t}t.tmpInputValue=null,t.selectedResult=null,t.debug=t.debug||!1,t.useKeywordFacet=!1,t.hasKeywordFacet=!1,t.$watch("facetList",function(e){t.sbFacetList=s(e),t.hasOwnProperty("selected")||(t.selected={key:"",value:""})}),t.$watch("resultList",function(e){t.sbResultList=i(e)});var l=[9,13,37,39];n.find("input").bind("keydown",function(n){-1!==l.indexOf(n.which)&&(n.preventDefault(),13===n.which?(t.useKeywordFacet=!0,e(function(){t.useKeywordFacet&&(t.selected.value="",t.hasKeywordFacet?(t.sbResultList[t.sbResultList.length-1].value+=" "+t.selected.key,t.resultList[t.resultList.length-1].value+=" "+t.selected.key):(t.hasKeywordFacet=!0,t.sbResultList.push({key:"text",type:"string",value:t.selected.key}),t.resultList.push({key:"text",type:"string",value:t.selected.key})),t.selected.key="",e(function(){t.selectInputFacet(),t.selectedResult=null}))})):9===n.which&&t.$apply(function(){}))}),t.bindValueInput=function(n){e(function(){n.find("input").bind("keydown",function(e){-1!==l.indexOf(e.which)&&(e.preventDefault(),(13===e.which||9===e.which)&&(console.log(e),t.hasKeywordFacet&&t.$apply(function(){if("text"!=t.sbResultList[t.sbResultList.length-1].key){var e=t.sbResultList.pop();t.sbResultList.splice(t.sbResultList.length-1,0,e)}}),t.$apply(function(){var n=new Object;n.key=t.sbResultList[e.target.dataset.tahIndex].key,n.type=t.sbResultList[e.target.dataset.tahIndex].type,n.value=t.sbResultList[e.target.dataset.tahIndex].value,t.resultList[e.target.dataset.tahIndex]=n,t.selectInputFacet(),t.selectedResult=null})))})})},t.selectInputFacet=function(){n.find("input")[n.find("input").length-1].focus()},t.getFacetLabel=function(e){for(var n in t.sbFacetList)if(t.sbFacetList[n].name==e)return t.sbFacetList[n].label;return e},t.getValueName=function(e,n,s){for(var a in t.sbFacetList)if(t.sbFacetList[a].name==e)return t.sbFacetList[a].items[n].name;return s},t.getValues=function(e){for(var n in t.sbFacetList)if(t.sbFacetList[n].name==e)return t.sbFacetList[n].items;return[]},t.$on("$typeahead.select",function(n,s,a,i){t.$apply(function(){t.useKeywordFacet=!1,-1==i?(t.selected.value="",t.sbResultList.push({key:s.name,type:s.type,value:""}),t.selected.key=""):e(function(){if(t.hasKeywordFacet&&"text"!=t.sbResultList[t.sbResultList.length-1].key){var e=t.sbResultList.pop();t.sbResultList.splice(t.sbResultList.length-1,0,e),i+=-1}var n=new Object;n.key=t.sbResultList[i].key,n.type=t.sbResultList[i].type,n.value=t.getValueName(n.key,a,s),t.resultList[i]=n,t.selectInputFacet(),t.selectedResult=null},100)})}),t.selectResult=function(e){t.selectedResult=e},t.removeFilter=function(e){"text"===t.sbResultList[e].key&&(t.hasKeywordFacet=!1),t.sbResultList.splice(e,1),t.resultList=t.sbResultList.slice(0)},t.removeAll=function(){t.hasKeywordFacet=!1,t.sbResultList.length=0,t.resultList.length=0}}}}]),angular.module("angularjssearchbox.typeahead",["mgcrea.ngStrap.tooltip","mgcrea.ngStrap.helpers.parseOptions"]).provider("$typeahead",function(){var e=this.defaults={animation:"am-fade",prefixClass:"typeahead",placement:"bottom-left",template:"templates/typeAhead.html",trigger:"focus",container:!1,keyboard:!0,html:!1,delay:0,minLength:1,tahIndex:-1,filter:"filter",limit:6};this.$get=function(t,n,s){function a(t,n,a){var i={},l=angular.extend({},e,a);i=s(t,l);var u=a.scope,c=i.$scope;c.$resetMatches=function(){c.$matches=[],c.$activeIndex=0},c.$resetMatches(),c.$activate=function(e){c.$$postDigest(function(){i.activate(e)})},c.$select=function(e){c.$$postDigest(function(){i.select(e)})},c.$isVisible=function(){return i.$isVisible()},i.update=function(e){c.$matches=e,c.$activeIndex>=e.length&&(c.$activeIndex=0)},i.activate=function(e){c.$activeIndex=e},i.select=function(e){var t=c.$matches[e].value;n.$setViewValue(t),c.$resetMatches(),n.$render(),u&&u.$digest(),c.$emit("$typeahead.select",t,e,l.tahIndex)},i.$isVisible=function(){return l.minLength&&n?c.$matches.length&&angular.isString(n.$viewValue)&&n.$viewValue.length>=l.minLength:!!c.$matches.length},i.$getIndex=function(e){var t=c.$matches.length,n=t;if(t){for(n=t;n--&&c.$matches[n].value!==e;);if(!(0>n))return n}},i.$onMouseDown=function(e){e.preventDefault(),e.stopPropagation()},i.$onKeyDown=function(e){/(38|40|13)/.test(e.keyCode)&&(e.preventDefault(),e.stopPropagation(),13===e.keyCode&&c.$matches.length?i.select(c.$activeIndex):38===e.keyCode&&c.$activeIndex>0?c.$activeIndex--:40===e.keyCode&&c.$activeIndex<c.$matches.length-1?c.$activeIndex++:angular.isUndefined(c.$activeIndex)&&(c.$activeIndex=0),c.$digest())};var r=i.show;i.show=function(){r(),setTimeout(function(){i.$element.on("mousedown",i.$onMouseDown),l.keyboard&&t.on("keydown",i.$onKeyDown)})};var o=i.hide;return i.hide=function(){i.$element.off("mousedown",i.$onMouseDown),l.keyboard&&t.off("keydown",i.$onKeyDown),o()},i}angular.element(t.document.body);return a.defaults=e,a}}).directive("sbTypeahead",function(e,t,n,s,a){var i=s.defaults;return{restrict:"EAC",require:"ngModel",link:function(e,t,n,l){var u={scope:e};angular.forEach(["placement","container","delay","trigger","keyboard","html","animation","template","filter","limit","tahIndex","minLength"],function(e){angular.isDefined(n[e])&&(u[e]=n[e])});var c=u.filter||i.filter,r=u.limit||i.limit,o=n.ngOptions;c&&(o+=" | "+c+":$viewValue"),r&&(o+=" | limitTo:"+r);var d=a(o),f=function(){d=a(o),d.valuesFn(e,l).then(function(t){t.length>r&&(t=t.slice(0,r)),(1!==t.length||t[0].value!==e.$modelValue)&&(h.update(t),l.$render())})};n.ngOptionsWatch&&e.$watch(n.ngOptionsWatch,f);var h=s(t,l,u);e.$watch(n.ngModel,function(t){e.$modelValue=t,f()}),l.$render=function(){if(l.$isEmpty(l.$viewValue))return t.val("");var e=h.$getIndex(l.$modelValue),n=angular.isDefined(e)?h.$scope.$matches[e].label:l.$viewValue;n=angular.isObject(n)?n.label:n,t.val(n.replace(/<(?:.|\n)*?>/gm,"").trim())},e.$on("$destroy",function(){h.destroy(),u=null,h=null})}}});