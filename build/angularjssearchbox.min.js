"use strict";angular.module("angularjssearchbox",["angularjssearchbox.typeahead","ngDateRange"]).directive("sbFocus",["$timeout",function(e){return function(t,n){e(function(){t.useKeywordFacet||n[0].value||n[0].focus()})}}]).directive("repeatDone",function(){return function(e,t){e.bindValueInput(t)}}).directive("searchBox",["$timeout",function(e){return{restrict:"A",templateUrl:"templates/searchBox.html",scope:{resultList:"=",facetList:"=",debug:"=?",dateOptions:"=?"},link:function(t,n){function a(e){for(var t in e)for(var n in e[t].items)e[t].items[n].hasOwnProperty("label")||(e[t].items[n].label=e[t].items[n].name);return e}function s(e,n){for(var a in t.facetList)if(t.facetList[a].name===e)for(var s in t.facetList[a].items)if(t.facetList[a].items[s].name===n)return t.facetList[a].items[s].label;return n}function i(e){for(var n in t.facetList)if(t.facetList[n].name===e)return t.facetList[n].type;return"string"}function l(e){var t=[];for(var n in e){var a=new Object;a.key=e[n].key,a.type=i(a.key),a.value=s(a.key,e[n].value),t.push(a)}return t}t.tmpInputValue=null,t.selectedResult=null,t.debug=t.debug||!1,t.useKeywordFacet=!1,t.hasKeywordFacet=!1,t.toDay=moment().format("DD/MM/YYYY"),t.dateOptions=t.dateOptions||{minDate:"01/01/2004",maxDate:moment().add("years",2),showDropdowns:!0,showWeekNumbers:!1,timePicker:!1,timePickerIncrement:1,timePicker12Hour:!1,ranges:{"Aujourd'hui":[moment(),moment()],"Semestre en cours":moment().get("month")<6?[moment().startOf("year"),moment().startOf("year").add("months",6).subtract("days",1)]:[moment().startOf("year").add("months",6),moment().endOf("year")],"Prochain Semestre":moment().get("month")<6?[moment().startOf("year").add("months",6),moment().endOf("year")]:[moment().startOf("year").add("years",1),moment().endOf("year").add("months",6)],"Mois dernier":[moment().subtract("month",1).startOf("month"),moment().subtract("month",1).endOf("month")],"Mois c +1 ":[moment().startOf("month"),moment().add("month",1).endOf("month")]},opens:"right",buttonClasses:["btn btn-default"],applyClass:"btn-small btn-primary",cancelClass:"btn-small",format:"DD/MM/YYYY",separator:" - ",singleDatePicker:!1,locale:{applyLabel:"Valider",cancelLabel:"Annuler",fromLabel:"Du",toLabel:"Au",customRangeLabel:"Calendrier",daysOfWeek:["Di","Lu","Ma","Me","Je","Ve","Sa"],monthNames:["Janvier","F&eacute;vrier","Mars","Avril","Mai","Juin","Juillet","Ao&ucirc;t","Septembre","Octobre","Novembre","D&eacute;cembre"],firstDay:1}},t.dateOptionsDate=angular.copy(t.dateOptions),t.dateOptionsDate.singleDatePicker=!0,t.dateOptionsRange=angular.copy(t.dateOptions),t.changeEventDateRange=function(){var n=this.element.context.value,a=this.element[0].attributes[1].value;t.sbResultList[a].value=n,e(function(){if(t.hasKeywordFacet&&"text"!=t.sbResultList[t.sbResultList.length-1].key){var e=t.sbResultList.pop();t.sbResultList.splice(t.sbResultList.length-1,0,e),a+=-1}var s=new Object;s.key=t.sbResultList[a].key,s.type=t.sbResultList[a].type,s.value=n,t.resultList[a]=s,t.selectInputFacet(),t.selectedResult=null},100)},t.$watch("facetList",function(e){t.sbFacetList=a(e),t.sbResultList=l(t.resultList),t.hasOwnProperty("selected")||(t.selected={key:"",value:""})}),t.$watch("resultList",function(e){t.sbResultList=l(e)});var u=[9,13,37,39];n.find("input").bind("keydown",function(n){-1!==u.indexOf(n.which)&&(n.preventDefault(),13===n.which?(t.useKeywordFacet=!0,e(function(){t.useKeywordFacet&&(t.selected.value="",t.hasKeywordFacet?(t.sbResultList[t.sbResultList.length-1].value+=" "+t.selected.key,t.resultList[t.resultList.length-1].value+=" "+t.selected.key):(t.hasKeywordFacet=!0,t.sbResultList.push({key:"text",type:"string",value:t.selected.key}),t.resultList.push({key:"text",type:"string",value:t.selected.key})),t.selected.key="",e(function(){t.selectInputFacet(),t.selectedResult=null}))})):9===n.which&&t.$apply(function(){}))}),t.bindValueInput=function(n){e(function(){n.find("input").bind("keydown",function(e){-1!==u.indexOf(e.which)&&(e.preventDefault(),(13===e.which||9===e.which)&&(t.hasKeywordFacet&&t.$apply(function(){if("text"!=t.sbResultList[t.sbResultList.length-1].key){var e=t.sbResultList.pop();t.sbResultList.splice(t.sbResultList.length-1,0,e)}}),t.$apply(function(){var n=new Object;n.key=t.sbResultList[e.target.dataset.tahIndex].key,n.type=t.sbResultList[e.target.dataset.tahIndex].type,n.value=t.sbResultList[e.target.dataset.tahIndex].value,t.resultList[e.target.dataset.tahIndex]=n,t.selectInputFacet(),t.selectedResult=null})))})})},t.selectInputFacet=function(){n.find("input")[n.find("input").length-1].focus()},t.getFacetLabel=function(e){for(var n in t.sbFacetList)if(t.sbFacetList[n].name==e)return t.sbFacetList[n].label;return e},t.getValueName=function(e,n,a){for(var s in t.sbFacetList)if(t.sbFacetList[s].name==e)return t.sbFacetList[s].items[n].name;return a},t.getValues=function(e){for(var n in t.sbFacetList)if(t.sbFacetList[n].name==e)return t.sbFacetList[n].items;return[]},t.$on("$typeahead.select",function(n,a,s,i){t.$apply(function(){t.useKeywordFacet=!1,-1==i?(t.selected.value="",t.sbResultList.push({key:a.name,type:a.type,value:""}),t.selected.key=""):e(function(){if(t.hasKeywordFacet&&"text"!=t.sbResultList[t.sbResultList.length-1].key){var e=t.sbResultList.pop();t.sbResultList.splice(t.sbResultList.length-1,0,e),i+=-1}var n=new Object;n.key=t.sbResultList[i].key,n.type=t.sbResultList[i].type,n.value=t.getValueName(n.key,s,a),t.resultList[i]=n,t.selectInputFacet(),t.selectedResult=null},100)})}),t.selectResult=function(e){t.selectedResult=e},t.removeFilter=function(e){"text"===t.sbResultList[e].key&&(t.hasKeywordFacet=!1),t.sbResultList.splice(e,1),t.resultList=t.sbResultList.slice(0)},t.removeAll=function(){t.hasKeywordFacet=!1,t.sbResultList.length=0,t.resultList.length=0}}}}]),angular.module("angularjssearchbox.typeahead",["mgcrea.ngStrap.tooltip","mgcrea.ngStrap.helpers.parseOptions"]).provider("$typeahead",function(){var e=this.defaults={animation:"am-fade",prefixClass:"typeahead",placement:"bottom-left",template:"templates/typeAhead.html",trigger:"focus",container:!1,keyboard:!0,html:!1,delay:0,minLength:1,tahIndex:-1,filter:"filter",limit:6};this.$get=function(t,n,a){function s(t,n,s){var i={},l=angular.extend({},e,s);i=a(t,l);var u=s.scope,r=i.$scope;r.$resetMatches=function(){r.$matches=[],r.$activeIndex=0},r.$resetMatches(),r.$activate=function(e){r.$$postDigest(function(){i.activate(e)})},r.$select=function(e){r.$$postDigest(function(){i.select(e)})},r.$isVisible=function(){return i.$isVisible()},i.update=function(e){r.$matches=e,r.$activeIndex>=e.length&&(r.$activeIndex=0)},i.activate=function(e){r.$activeIndex=e},i.select=function(e){var t=r.$matches[e].value;n.$setViewValue(t),r.$resetMatches(),n.$render(),u&&u.$digest(),r.$emit("$typeahead.select",t,e,l.tahIndex)},i.$isVisible=function(){return l.minLength&&n?r.$matches.length&&angular.isString(n.$viewValue)&&n.$viewValue.length>=l.minLength:!!r.$matches.length},i.$getIndex=function(e){var t=r.$matches.length,n=t;if(t){for(n=t;n--&&r.$matches[n].value!==e;);if(!(0>n))return n}},i.$onMouseDown=function(e){e.preventDefault(),e.stopPropagation()},i.$onKeyDown=function(e){/(38|40|13)/.test(e.keyCode)&&(e.preventDefault(),e.stopPropagation(),13===e.keyCode&&r.$matches.length?i.select(r.$activeIndex):38===e.keyCode&&r.$activeIndex>0?r.$activeIndex--:40===e.keyCode&&r.$activeIndex<r.$matches.length-1?r.$activeIndex++:angular.isUndefined(r.$activeIndex)&&(r.$activeIndex=0),r.$digest())};var o=i.show;i.show=function(){o(),setTimeout(function(){i.$element.on("mousedown",i.$onMouseDown),l.keyboard&&t.on("keydown",i.$onKeyDown)})};var c=i.hide;return i.hide=function(){i.$element.off("mousedown",i.$onMouseDown),l.keyboard&&t.off("keydown",i.$onKeyDown),c()},i}angular.element(t.document.body);return s.defaults=e,s}}).directive("sbTypeahead",function(e,t,n,a,s){var i=a.defaults;return{restrict:"EAC",require:"ngModel",link:function(e,t,n,l){var u={scope:e};angular.forEach(["placement","container","delay","trigger","keyboard","html","animation","template","filter","limit","tahIndex","minLength"],function(e){angular.isDefined(n[e])&&(u[e]=n[e])});var r=u.filter||i.filter,o=u.limit||i.limit,c=n.ngOptions;r&&(c+=" | "+r+":$viewValue"),o&&(c+=" | limitTo:"+o);var d=s(c),m=function(){d=s(c),d.valuesFn(e,l).then(function(t){t.length>o&&(t=t.slice(0,o)),(1!==t.length||t[0].value!==e.$modelValue)&&(f.update(t),l.$render())})};n.ngOptionsWatch&&e.$watch(n.ngOptionsWatch,m);var f=a(t,l,u);e.$watch(n.ngModel,function(t){e.$modelValue=t,m()}),l.$render=function(){if(l.$isEmpty(l.$viewValue))return t.val("");var e=f.$getIndex(l.$modelValue),n=angular.isDefined(e)?f.$scope.$matches[e].label:l.$viewValue;n=angular.isObject(n)?n.label:n,t.val(n.replace(/<(?:.|\n)*?>/gm,"").trim())},e.$on("$destroy",function(){f.destroy(),u=null,f=null})}}});